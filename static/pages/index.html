<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Wewin Auto Testing System</title>
    <link rel="stylesheet" href="../layui/css/layui.css">
    <link rel="stylesheet" href="../css/main.css">
</head>

<body>
    <div class="main">
        <div class="edit">
            <table class="layui-hide" id="demo" lay-filter="test"></table>
            <div class="disactive" id="toolbarDemo">
                <div class="layui-btn-container">
                    <button class="layui-btn layui-btn-sm layui-btn-normal add-new-test" lay-event="addNewTest">新增用例</button>
                    <button class="layui-btn layui-btn-sm layui-btn-normal delete-mul" lay-event="deleteMul">批量删除</button>
                    <button class="layui-btn layui-btn-sm layui-btn-normal goto-run" lay-event="gotoRun">加入执行</button>
                    <button class="layui-btn layui-btn-sm run-test" lay-event="runText">运行</button>
                    <button class="layui-btn layui-btn-sm stop-test layui-btn-danger" lay-event="stopText">停止</button>
                </div>
            </div>
            <div class="disactive" id="barDemo">
                <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
            </div>
        </div>
        <div class="runlist noselect">
            <blockquote class="layui-elem-quote layui-quote-nm">执行顺序，从上往下
                <br>(鼠标拖放调整顺序)</blockquote>
            <hr class="layui-bg-orange">
            <div id="run-sort">无数据</div>
            <script id="run-sort-temp" type="text/html">
                {{#  layui.each(d.list, function(index, item){ }}
                    <div class="sort-item id{{item.id}}">{{ item.title }} <i class="layui-icon layui-icon-close" onclick="delItem(this)"></i></div>
                {{#  }); }}
            </script>
        </div>
    </div>
    <script src="../layui/layui.js"></script>
    <script src="../js/Sortable.min.js"></script>
    <script>
        var Sortable = require('../js/Sortable.min.js');
        const { remote } = require('electron');
        var child_process = require('child_process');
        var path = require('path');
        var xlsx = require("node-xlsx");
        var pyPath = path.dirname(remote.app.getPath('exe'));

        var run_sort = document.getElementById('run-sort');
        new Sortable(run_sort, {
            animation: 150,
            ghostClass: 'blue-background-class',
            onUpdate: function (evt) {
                console.log(1);
            },
        });
        layui.use(['layer', 'table', 'laytpl'], function () {
            var table = layui.table;
            var laytpl = layui.laytpl;
            window.$ = layui.$;

            table.render({
                elem: '#demo'
                , toolbar: '#toolbarDemo'
                , height: 'full-0'
                , cols: [[ //标题栏
                    { type: 'checkbox', fixed: 'left' }
                    , { field: 'url', title: '脚本', width: 80, hide: true, fixed: 'left' }
                    , { field: 'id', title: '编号', width: 80, sort: true, fixed: 'left' }
                    , { field: 'title', title: '用例标题', width: 160 }
                    , { field: 'content', title: '步骤' }
                    , { field: 'hope', title: '预期' }
                    , { fixed: 'right', title: '操作', toolbar: '#barDemo', width: 80 }
                ]]
                , limit: 20
                , data: [{
                    "url": "demo1"
                    , "id": "1"
                    , "title": "单击文字操作1"
                    , "content": `1. 从首页点击“编辑我的编辑+“`
                    , "hope": `1. 进入自由编辑页面 `
                }, {
                    "url": "demo2"
                    , "id": "2"
                    , "title": "单击文字操作2"
                    , "content": `2. 从首页点击“编辑我的编辑+“`
                    , "hope": `2. 进入自由编辑页面 `
                }, {
                    "url": "demo3"
                    , "id": "3"
                    , "title": "单击文字操作3"
                    , "content": `3. 从首页点击“编辑我的编辑+“`
                    , "hope": `3. 进入自由编辑页面 `
                }]
                , page: true //是否显示分页
            });

            //头工具栏事件
            table.on('toolbar(test)', function (obj) {
                var checkStatus = table.checkStatus(obj.config.id);
                switch (obj.event) {
                    case 'addNewTest':
                        //新增用例
                        var data = checkStatus.data;
                        break;
                    case 'deleteMul':
                        //批量删除
                        var data = checkStatus.data;
                        break;
                    case 'gotoRun':
                        //加入执行
                        var len = $(".sort-item").length;
                        var d = checkStatus.data;
                        var data = { //数据
                            "list": d
                        }
                        var getTpl = document.getElementById('run-sort-temp').innerHTML
                            , view = document.getElementById('run-sort');
                        if (len == 0) {
                            laytpl(getTpl).render(data, function (html) {
                                view.innerHTML = html;
                            });
                        } else {
                            var newArr = [];
                            for (var i = 0; i < d.length; i++) {
                                var temp = true;
                                for (var j = 0; j < $(".sort-item").length; j++) {
                                    if (d[i].id == $(".sort-item")[j].className.replace("sort-item id", "")) {
                                        temp = false;
                                        break;
                                    }
                                }
                                if (temp) {
                                    newArr.push(d[i]);
                                }
                            }
                            var data = { //数据
                                "list": newArr
                            }
                            laytpl(getTpl).render(data, function (html) {
                                view.innerHTML += html;
                            });
                        }
                        break;
                    case 'runText':
                        //运行
                        var data = checkStatus.data;
                        break;
                    case 'stopText':
                        // 停止
                        var data = checkStatus.data;
                        break;
                };
            });

            //监听行工具事件
            table.on('tool(test)', function (obj) {
                var data = obj.data;
                if (obj.event === 'del') {
                    layer.confirm('真的删除行么', function (index) {
                        obj.del();
                        layer.close(index);
                    });
                }
            });
        });

        function delItem(obj) {
            layer.confirm('确认删除？', function (index) {
                $(obj).parent().remove();
                layer.close(index);
            });
        }

        function RunTest(num) {
            child_process.exec(`start cmd.exe /K python \"${pyPath}/testing-files/demo${num}.air/demo${num}.py\"`);
        }

        function show() {
            window.open("./about.html", "_blank", "nodeIntegration=no");
        }

        function getXls() {
            layer.alert('内容')
            var obj = xlsx.parse(`${pyPath}/testing-files/data.xls`);
            var sheet = obj[0].data;
            var data = [];
            var result, tag, img;
            for (var j = 0; j < sheet.length; j++) {
                var json = {};
                result = sheet[j][0];
                tag = sheet[j][1];
                var isEmpty = result == "" || result == null || result == undefined || tag == "" || tag == null || tag == undefined;

                if (!isEmpty) {
                    json["result"] = result;
                    json["tag"] = tag;
                    data.push(json);
                }
            }
            console.log(data);
        }


    </script>
</body>

</html>