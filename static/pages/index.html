<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Wewin Auto Testing System</title>
    <link rel="stylesheet" href="../layui/css/layui.css">
    <link rel="stylesheet" href="../css/main.css">
</head>

<body>
    <div class="main">
        <div class="edit">
            <table class="layui-hide" id="demo" lay-filter="test"></table>
        </div>
        <div class="runlist noselect">
            <blockquote class="layui-elem-quote layui-quote-nm">
                <span style="font-size:20px;font-weight:bold;">执行区</span>
                <br>执行顺序: 从上往下
                <br>(鼠标拖放调整顺序)</blockquote>
            <hr class="layui-bg-orange">
            <div id="run-sort">无数据</div>
            <div class="mask"></div>
        </div>
    </div>
    <div class="disactive" id="toolbarDemo">
        <div class="layui-btn-container">
            <div class="layui-btn-group">
                <button class="layui-btn layui-btn-sm layui-btn-normal add-new-test" lay-event="addTest">新增用例</button>
                <button class="layui-btn layui-btn-sm layui-btn-normal delete-mul"
                    lay-event="deleteTest">批量删除用例</button>
            </div>
            <div class="layui-btn-group">
                <button class="layui-btn layui-btn-sm layui-btn-normal goto-run" lay-event="addRun">加入执行</button>
                <button class="layui-btn layui-btn-sm layui-btn-normal goto-run" lay-event="deleteRun">删除全部执行</button>
            </div>
            <div class="layui-btn-group">
                <button class="layui-btn layui-btn-sm run-test" lay-event="runText">运行</button>
                <!-- <button class="layui-btn layui-btn-sm run-test" lay-event="runTextDemo">运行测试</button> -->
                <button class="layui-btn layui-btn-sm stop-test layui-btn-danger" lay-event="stopText">停止</button>
            </div>
        </div>
    </div>
    <div class="disactive" id="gotourl">
        <a class="gotourl" href="http://service.wewin.com.cn:8073{{d.url}}">下载</a>
    </div>
    <div class="disactive" id="barDemo">
        <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit">修改</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
    </div>
    <div class="disactive" id="addTest">
        <form class="layui-form layui-form-pane" action="" lay-filter="example">
            <div class="layui-form-item">
                <label class="layui-form-label">用例标题</label>
                <div class="layui-input-block">
                    <input type="text" name="title" lay-verify="title" autocomplete="off" placeholder="请输入用例标题"
                        class="layui-input">
                </div>
            </div>
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">用例步骤</label>
                <div class="layui-input-block">
                    <textarea placeholder="请输入用例步骤" class="layui-textarea" name="content"
                        lay-verify="content"></textarea>
                </div>
            </div>
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">用例预期</label>
                <div class="layui-input-block">
                    <textarea placeholder="请输入用例预期" class="layui-textarea" name="hope" lay-verify="hope"></textarea>
                </div>
            </div>
            <div class="layui-form-item">
                <button class="layui-btn layui-btn-normal upload-case" lay-submit="" lay-filter="demo1">提交用例</button>
                <button type="reset" class="layui-btn layui-btn-primary"
                    style="margin-left:0px;width:100%;margin-top:15px;">重置表单</button>
            </div>
        </form>
    </div>
    <div class="disactive" id="addTest2">
        <div class="layui-upload-drag" id="zipfile">
            <i class="layui-icon"></i>
            <p>点击上传，或将文件拖拽到此处</p>
        </div>
        <fieldset class="layui-elem-field" style="margin-top:15px;">
            <legend>用例文件信息</legend>
            <div class="layui-field-box">
                文件名：<span class="filename">无</span>
            </div>
            <!-- <div class="layui-field-box">
                文件路径：<span class="filepath">无</span>
            </div> -->
            <div class="layui-field-box">
                文件大小：<span class="filesize">无</span>
            </div>
        </fieldset>
        <button class="layui-btn layui-btn-normal" id="uploadFile">上传文件</button>
    </div>
    <script src="../layui/layui.js"></script>
    <script src="../js/Sortable.min.js"></script>
    <script src="../js/main.js"></script>
    <script>
        //初始化参数
        var Sortable = require('../js/Sortable.min.js');
        const { remote } = require('electron');
        var child_process = require('child_process');
        var request = require('request');
        var fs = require('fs');
        var fse = require('fs-extra');
        var path = require('path');
        var unzip = require("unzip");
        var rimraf = require('rimraf');

        var pyPath = path.dirname(remote.app.getPath('exe'));
        var logPath = path.resolve(__dirname, '../..');
        //online
        // logPath = pyPath;

        try {
            fs.mkdirSync(logPath + "/logs");
        } catch (error) { }

        var uploadLayer, uploadId;
        var runningLoop, isRunning = 0;
        var runHtml = `
# -*- encoding=utf8 -*-
import sys
reload(sys)
sys.setdefaultencoding('gbk')

import os
import time

nowDate = time.strftime('%Y-%m-%d-%H-%M-%S',time.localtime(time.time())) + "";
f1 = open("./status-show.txt","w+")
f2 = open("./logs/auto-test-log(" + nowDate + ").txt","w+")

def writeLog(file, content):
    file.write(content)
    file.write("\\n")

def endLog():
    f1.close()
    f2.close()  

writeLog(f1,"#start")
writeLog(f2,"#start")

# -*- encoding=utf8 -*-
__author__ = "wewin"

from airtest.core.api import *

auto_setup(__file__)

from poco.drivers.android.uiautomation import AndroidUiautomationPoco
poco = AndroidUiautomationPoco(use_airtest_input=True, screenshot_each_action=False)                    

`;

        initSortable();
        //初始化拖拽
        function initSortable() {
            var run_sort = document.getElementById('run-sort');
            new Sortable(run_sort, {
                animation: 150,
                ghostClass: 'blue-background-class',
                onUpdate: function (evt) {
                    resetRunIndex();
                },
            });
        }

        //初始化layui
        layui.use(['layer', 'table', 'laytpl', 'form', 'upload'], function () {
            var form = layui.form;
            var table = layui.table;
            var laytpl = layui.laytpl;
            var upload = layui.upload;
            window.$ = layui.$;

            //重载数据
            function reloadTableData() {
                $.ajax({
                    type: 'get',
                    url: URL + '/list',
                    success(result) {
                        var allData = result.list;
                        for (var i = 0; i < allData.length; i++) {
                            allData[i].content = allData[i].content.replace(/\n/g, "<br/>");
                            allData[i].hope = allData[i].hope.replace(/\n/g, "<br/>");
                        }
                        table.reload('demo', {
                            data: allData
                        });
                    }
                })
            }

            //初始化上传文件组件
            initUpload();
            function initUpload() {
                var flag = true;
                upload.render({ //允许上传的文件后缀
                    elem: '#zipfile'
                    , url: URL + '/uploads'
                    , data: {
                        id: function () {
                            return uploadId + "";
                        }
                    }
                    , auto: false
                    , bindAction: '#uploadFile'
                    , size: 5120
                    , accept: 'file' //普通文件
                    , exts: 'zip' //只允许上传压缩文件
                    , choose: function (obj) {
                        //预读本地文件，如果是多文件，则会遍历。(不支持ie8/9)
                        obj.preview(function (index, file, result) {
                            console.log(file);
                            $(".filename").text(file.name);
                            // $(".filepath").text(file.path);
                            $(".filesize").text((~~(file.size / 1024) + 1) + "KB");
                            flag = true;
                        });
                    }
                    , before: function (obj) {
                        if (!flag) {
                            layer.msg('请先选择文件');
                        }
                        return flag;
                        layer.load();
                    }
                    , done: function (res, index, upload) {
                        flag = false;
                        $(".filename").text("无");
                        // $(".filepath").text("无");
                        $(".filesize").text("无");
                        $(".layui-upload-file").val('');
                        layer.closeAll();
                        layer.msg('上传成功');
                        reloadTableData();
                    }
                    , error: function (index, upload) {
                        layer.closeAll();
                        layer.msg('上传失败');
                    }
                });
            }

            //初始化新增用例表单
            initForm();
            function initForm() {
                form.verify({
                    title: function (value) {
                        if (value.trim().length == 0) {
                            return '标题不能为空啊';
                        }
                    },
                    content: function (value) {
                        if (value.trim().length == 0) {
                            return '步骤不能为空啊';
                        }
                    },
                    hope: function (value) {
                        if (value.trim().length == 0) {
                            return '期望不能为空啊';
                        }
                    }
                });
                form.on('submit(demo1)', function (data) {
                    // layer.alert(JSON.stringify(data.field), {
                    //     title: '最终的提交信息'
                    // })
                    $.ajax({
                        type: 'post',
                        url: URL + "/add",
                        data: {
                            title: data.field.title,
                            content: data.field.content,
                            hope: data.field.hope
                        },
                        success(result) {
                            console.log("新增用例:", result);
                            uploadId = result.list._id;
                            layer.close(uploadLayer);
                            layer.open({
                                type: 1,
                                title: '上传用例文件',
                                area: ['55%'],
                                content: $("#addTest2"),
                                cancel: function (index, layero) {
                                    if (confirm('确定要关闭么')) {
                                        $.ajax({
                                            type: 'get',
                                            url: URL + '/delete',
                                            data: {
                                                id: uploadId
                                            },
                                            success(result) {
                                                layer.close(index);
                                            }
                                        })
                                    }
                                    return false;
                                }
                            });
                        }
                    })
                    return false;
                });
                form.val('example', {
                    "title": "文本换行输入"
                    , "content": `1. 从首页点击“编辑我的标签+“
2. 点击“文字+”插入新文本
3. 多行输入,手动换行，自适应字号的指数达至400mm
4. 改变字号，打印
5. 改变字体，打印
6. 改变字体修饰，打印`
                    , "hope": `1. 进入自由编辑页面
2. 文本插入成功
3. 输入自适应字号变小，直至最小字号，以最长行为标准变换字号`
                })
            }

            //初始化表格
            $.ajax({
                type: 'get',
                url: URL + '/list',
                success(result) {
                    initTable(result.list);
                }
            })
            function initTable(allData) {

                console.log("api请求表格数据:", allData);
                for (var i = 0; i < allData.length; i++) {
                    allData[i].content = allData[i].content.replace(/\n/g, "<br/>");
                    allData[i].hope = allData[i].hope.replace(/\n/g, "<br/>");
                }

                table.render({
                    elem: '#demo'
                    , toolbar: '#toolbarDemo'
                    , height: 'full-0'
                    , defaultToolbar: ['filter', 'exports']
                    , cols: [[ //标题栏
                        { type: 'checkbox' }
                        , { field: '_id', title: '编号', width: 80, hide: false, unresize: true }
                        , { field: 'title', title: '用例标题', unresize: true }
                        , { field: 'content', title: '用例步骤', unresize: true, hide: true }
                        , { field: 'hope', title: '用例预期', unresize: true, hide: true }
                        , { field: 'url', title: '脚本', width: 60, hide: false, unresize: true, templet: '#gotourl' }
                        , { title: '操作', toolbar: '#barDemo', width: 120, unresize: true }
                    ]]
                    , limit: 20
                    , data: allData
                    , page: true //是否显示分页
                });

                //头工具栏事件
                table.on('toolbar(test)', function (obj) {
                    var checkStatus = table.checkStatus(obj.config.id);
                    var zipNum = 0;
                    switch (obj.event) {
                        case 'addTest':
                            if (isRun()) {
                                alert("正在运行中，请先停止！");
                                return;
                            }
                            //新增用例
                            var data = checkStatus.data;
                            uploadLayer = layer.open({
                                type: 1,
                                title: '新增用例',
                                area: ['55%'],
                                content: $("#addTest")
                            });
                            break;
                        case 'deleteTest':
                            if (isRun()) {
                                alert("正在运行中，请先停止！");
                                return;
                            }
                            //批量删除
                            var data = checkStatus.data;
                            if (data.length == 0) {
                                layer.msg('请先选择需要删除的用例');
                                return;
                            }
                            layer.confirm('确定要删除选中的用例？', function (index) {
                                var temp = 0;
                                layer.load();
                                var delItem = setInterval(() => {
                                    if (temp == data.length) {
                                        reloadTableData();
                                        layer.closeAll();
                                        layer.msg('删除成功');
                                        clearInterval(delItem);
                                    }
                                }, 5);
                                setTimeout(() => {
                                    for (var i = 0; i < data.length; i++) {
                                        (function (i) {
                                            $.ajax({
                                                type: 'get',
                                                url: URL + '/delete',
                                                data: {
                                                    id: data[i]._id
                                                },
                                                success(result) {
                                                    temp++;
                                                }
                                            })
                                        })(i);
                                    }
                                }, 0);
                            });
                            break;
                        case 'addRun':
                            if (isRun()) {
                                alert("正在运行中，请先停止！");
                                return;
                            }
                            //加入执行
                            var len = $(".sort-item").length;
                            var data = checkStatus.data;
                            var view = document.getElementById('run-sort');
                            if (data.length == 0) {
                                layer.msg('请先选择需要加入执行的用例');
                                return;
                            }
                            if (view.innerHTML.indexOf("无数据") != -1 && data.length != 0) {
                                view.innerHTML = "";
                            }
                            if (len == 0) {
                                for (var i = 0; i < data.length; i++) {
                                    view.innerHTML += `<div class="sort-item id${data[i]._id}"><div class="run-status"></div><span class="run-index"></span>${data[i].title}<i class="layui-icon layui-icon-close" onclick="delItem(this)"></i></div>`;
                                }
                            } else {
                                var newArr = [];
                                for (var i = 0; i < data.length; i++) {
                                    var temp = true;
                                    for (var j = 0; j < $(".sort-item").length; j++) {
                                        if (data[i]._id == $(".sort-item")[j].className.replace("sort-item id", "")) {
                                            temp = false;
                                            break;
                                        }
                                    }
                                    if (temp) {
                                        newArr.push(data[i]);
                                    }
                                }
                                console.log(newArr);
                                for (var i = 0; i < newArr.length; i++) {
                                    view.innerHTML += `<div class="sort-item id${newArr[i]._id}"><div class="run-status"></div><span class="run-index"></span>${newArr[i].title}<i class="layui-icon layui-icon-close" onclick="delItem(this)"></i></div>`;
                                }
                            }
                            resetRunIndex();
                            break;
                        case 'deleteRun':
                            if (isRun()) {
                                alert("正在运行中，请先停止！");
                                return;
                            }
                            //删除执行
                            if ($(".sort-item").length != 0) {
                                layer.confirm('确定要删除全部执行？', function (index) {
                                    var view = document.getElementById('run-sort');
                                    view.innerHTML = "无数据";
                                    layer.close(index);
                                });
                            } else {
                                layer.msg('当前无执行用例');
                                return;
                            }
                            break;
                        case 'runText':
                            if (isRun()) {
                                alert("正在运行中，请先停止！");
                                return;
                            }
                            //运行
                            var data = checkStatus.data;
                            var savePath = pyPath + "/temp";
                            var autoTestLogPath = pyPath + "/logs";
                            var sortItems = $(".sort-item");
                            if (sortItems.length == 0) {
                                layer.msg('当前无执行用例');
                                return;
                            }
                            showRunning(1);
                            try {
                                fs.mkdirSync(savePath)
                                fs.mkdirSync(autoTestLogPath)
                            } catch (error) { }
                            layer.load();
                            var temp = 0;
                            zipNum = sortItems.length;
                            var unzipItem = setInterval(() => {
                                if (temp == sortItems.length) {
                                    clearInterval(unzipItem);
                                    var readZipDir = fs.readdirSync(savePath);
                                    var temp2 = 0, zipNum = 0;
                                    for (var i = 0; i < readZipDir.length; i++) {
                                        if (readZipDir[i].indexOf(".zip") != -1) {
                                            zipNum++;
                                        }
                                    }
                                    var runItem = setInterval(() => {
                                        if (temp2 == zipNum) {
                                            clearInterval(runItem);
                                            var temp3 = 0;
                                            var allContent = [];
                                            setTimeout(() => {
                                                for (var q = 0; q < zipNum; q++) {
                                                    var readDir = fs.readdirSync(savePath + `/${q + 1}`);
                                                    temp3 = 0;
                                                    for (var j = 0; j < readDir.length; j++) {
                                                        if (readDir[j].split(".")[1] == "py") {
                                                            temp3 = j;
                                                            break;
                                                        }
                                                    }
                                                    var data = fs.readFileSync(savePath + `/${q + 1}/${readDir[temp3]}`);
                                                    var content = data.toString();
                                                    content = content.substring(content.indexOf("#start"), content.indexOf("#end") + 4);

                                                    //success
                                                    var one = content.split("#success")[0];
                                                    var two = content.split("#success")[1];
                                                    content = one;
                                                    content += `
        writeLog(f1,"$${q + 1}$-s")
        writeLog(f2,"√ 第${q + 1}个测试用例-执行成功")
                                                    `;
                                                    content += two;

                                                    //error
                                                    var one = content.split("#error")[0];
                                                    var two = content.split("#error")[1];
                                                    content = one;
                                                    content += `
        writeLog(f1,"$${q + 1}$-f")
        writeLog(f2,"× 第${q + 1}个测试用例-执行失败")
                                                    `;
                                                    content += two;

                                                    content = `#第${q + 1}个测试用例--------------------\n` + content + "\n#--------------------------------";
                                                    allContent.push(content);
                                                }

                                                fs.mkdir(savePath + "/run", function (err) {
                                                    var html = runHtml;
                                                    for (var i = 0; i < allContent.length; i++) {
                                                        html += allContent[i];
                                                        html += `

endLog()
f1 = open("./status-show.txt","a+")
f2 = open("./logs/auto-test-log(" + nowDate + ").txt","a+")
writeLog(f2,"")`;
                                                        html += "\n\n";
                                                    }
                                                    html += `
writeLog(f1,"#end")
writeLog(f2,"#end")
endLog()`;
                                                    //复制所有图片到run目录下
                                                    for (var i = 0; i < zipNum; i++) {
                                                        var readDir = fs.readdirSync(savePath + `/${i + 1}`);
                                                        for (var j = 0; j < readDir.length; j++) {
                                                            if (readDir[j].split(".")[1] != "py") {
                                                                fse.copySync(savePath + `/${i + 1}/` + readDir[j], savePath + "/run/" + readDir[j]);
                                                            }
                                                        }
                                                    }

                                                    fs.writeFile(savePath + "/run/run.py", html, function (err) {
                                                        if (err) {
                                                            return console.error('创建文件出错！', err);
                                                        }
                                                        console.log("数据写入成功！");
                                                        layer.closeAll();
                                                        layer.msg("执行成功");

                                                        var runStatus = $(".run-status");
                                                        var all = "", result = "", ii, iiLen, resultObj = {};
                                                        runningLoop = setInterval(() => {
                                                            try {
                                                                var data = fs.readFileSync(logPath + "/status-show.txt");
                                                                var content = data.toString();
                                                                for (var i = 0; i < runStatus.length; i++) {
                                                                    x
                                                                    ii = i + 1;
                                                                    iiLen = ii.toString().length;
                                                                    if (iiLen == 1) {
                                                                        all = content.substr(content.lastIndexOf("$" + ii + "$"), 5);
                                                                    } else if (iiLen == 2) {
                                                                        all = content.substr(content.lastIndexOf("$" + ii + "$"), 6);
                                                                    } else if (iiLen == 3) {
                                                                        all = content.substr(content.lastIndexOf("$" + ii + "$"), 7);
                                                                    }
                                                                    result = all.split("-")[1];
                                                                    resultObj["item" + ii] = result;
                                                                    if (result == "s") {
                                                                        runStatus[i].className = "run-status success";
                                                                    } else if (result == "f") {
                                                                        runStatus[i].className = "run-status fail";
                                                                    } else {
                                                                        runStatus[i].className = "run-status";
                                                                    }
                                                                }
                                                            } catch (error) { }
                                                        }, 300);
                                                        setTimeout(() => {
                                                            child_process.exec(`start cmd.exe /K python \"${savePath}/run/run.py\"`);
                                                        }, 0);
                                                    });
                                                });
                                            }, 1500);
                                        }
                                    }, 10);
                                    setTimeout(() => {
                                        for (var i = 0; i < readZipDir.length; i++) {
                                            (function (i) {
                                                if (readZipDir[i].indexOf(".zip") != -1) {
                                                    var extract = unzip.Extract({ path: savePath + `/${readZipDir[i].split(".")[0]}` });
                                                    extract.on('finish', function () {
                                                        console.log("解压完成!!");
                                                        temp2++;
                                                    });
                                                    extract.on('error', function (err) {
                                                        console.log(err);
                                                    });
                                                    fs.createReadStream(savePath + `/${readZipDir[i]}`).pipe(extract);
                                                }
                                            })(i);
                                        }
                                    }, 0);
                                }
                            }, 5);
                            setTimeout(() => {
                                for (var i = 0; i < sortItems.length; i++) {
                                    (function (i) {
                                        var _id = $(".sort-item")[i].className.replace("sort-item id", "");
                                        var downPath = URL + `/zip/${_id}.zip`;
                                        var filename = savePath + `/${i + 1}.zip`;
                                        downloadFile(downPath, filename, function () {
                                            console.log('第' + (i + 1) + '个文件下载完毕 id:' + _id);
                                            temp++;
                                        });
                                    })(i);
                                }
                            }, 0);
                            break;
                        case 'runTextDemo':
                            break;
                        case 'stopText':
                            // 停止
                            var data = checkStatus.data;
                            clearInterval(runningLoop);

                            var runStatus = $(".run-status");
                            for (var i = 0; i < runStatus.length; i++) {
                                runStatus[i].className = "run-status";
                            }

                            var paths = [pyPath + "/temp", logPath + "/status-show.txt"];
                            for (var i = 0; i < paths.length; i++) {
                                (function (i) {
                                    rimraf(paths[i], function (err) {
                                        if (err) {
                                            console.log(err);
                                            return;
                                        }
                                        console.log(paths[i] + " del complete");
                                    });
                                })(i);
                            }
                            showRunning(0);
                            break;
                    };
                });

                //监听行工具事件
                table.on('tool(test)', function (obj) {
                    var data = obj.data;
                    var _id = data._id;
                    if (obj.event === 'del') {
                        layer.confirm('确定删除？', function (index) {
                            $.ajax({
                                type: 'get',
                                url: URL + '/delete',
                                data: {
                                    id: _id
                                },
                                success(result) {
                                    if (result.msg == "delete success!") {
                                        layer.msg('删除成功');
                                        obj.del();
                                    } else {
                                        layer.msg('删除失败');
                                    }
                                    layer.close(index);
                                }
                            })
                        });
                    }
                });
            }

        });

        function isRun() {
            return isRunning == 0 ? false : true;
        }

        function showRunning(type) {
            if (type == 0) {
                $(".runlist .mask").removeClass("active");
                isRunning = 0;
            }
            if (type == 1) {
                $(".runlist .mask").addClass("active");
                isRunning = 1;
            }
        }

        function downloadFile(uri, filename, callback) {
            var stream = fs.createWriteStream(filename);
            request(uri).pipe(stream).on('close', callback);
        }

        function delItem(obj) {
            layer.confirm('确认删除？', function (index) {
                $(obj).parent().remove();
                var len = $(".sort-item").length;
                if (len == 0) {
                    var view = document.getElementById('run-sort');
                    view.innerHTML = "无数据";
                }
                layer.close(index);
                resetRunIndex();
            });
        }

        function resetRunIndex() {
            var runIndex = $(".run-index");
            var runStatus = $(".run-status");
            for (var i = 0; i < runStatus.length; i++) {
                runStatus[i].className = "run-status";
            }
            for (var i = 0; i < runIndex.length; i++) {
                runIndex[i].innerHTML = i + 1 + ". ";
                runStatus[i].className += " s" + (i + 1);
            }
        }

        function RunTest(num) {
            child_process.exec(`start cmd.exe /K python \"${pyPath}/testing-files/demo${num}.air/demo${num}.py\"`);
        }

        function show() {
            window.open("./about.html", "_blank", "nodeIntegration=no");
        }

    </script>
</body>

</html>